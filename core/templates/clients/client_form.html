{% extends "base.html" %}

{% block content %}
  <div class="container mt-4">

    {% if messages %}
      <div class="alert-container">
        {% for message in messages %}
          <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="card shadow-sm">
      {% if object %}
        <div class="card-header bg-primary text-white text-end">
          <h1 class="text-white">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h1>
        </div>
      {% else %}
        <div class="card-header bg-success text-white text-end">
          <h1 class="text-white">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
        </div>
      {% endif %}
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" class="custom-form">
          {% csrf_token %}
          <h4 class="text-center mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
          <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙÙˆÙ ÙˆØ£Ø¹Ù…Ø¯Ø© (Grid System) Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
          <div class="row">
            <div class="col-12 col-md-8">
              <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
              <div class="mb-3">
                <label for="id_name" class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                {{ form.name }}
              </div>
              <div class="mb-3">
                <label for="id_type" class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                {{ form.type }}
              </div>
              <div class="mb-3">
                <label for="id_category" class="form-label">Ø§Ù„ÙØ¦Ø©</label>
                {{ form.category }}
              </div>
              <div class="mb-3">
                <label for="id_balance" class="form-label">Ø§Ù„Ø±ØµÙŠØ¯</label>
                {{ form.balance }}
              </div>
              <div class="mb-3">
                <label for="id_join_date" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</label>
                {{ form.join_date }}
              </div>
            </div>
            
            <!-- ØªØ®ØµÙŠØµ Ø¹Ø±Ø¶ Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ -->
            <div class="col-12 col-md-4">
              <div class="mb-3">
                <label for="id_image" class="form-label mb-2" style="width: 100%;">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
                
                <!-- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© -->
                {% if form.instance.image %}
                  <div>
                    <img src="{{ form.instance.image.url }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„"  class="rounded-circle" style="width: 200px; height: 200px; object-fit: cover;">
                  </div>
                {% endif %}
                
                <!-- Ø­Ù‚Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© -->
                {{ form.image }}
              </div>
            </div>
          </div>
          <hr>
          <!-- Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
          <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
            <h4>ğŸ“ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ</h4>
            <button type="button" id="add-phone" class="btn btn-primary btn-sm">â• Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙ</button>
          </div>
          {{ phone_formset.management_form }}
          <table id="phone-table" class="table text-center">
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø¥Ø²Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for form in phone_formset %}
                <tr class="phone-row">
                  <td>{{ form.id }}{{ form.phone }}</td>
                  <td>
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                    {% else %}
                      <button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
          <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
            <h4>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h4>
            <button type="button" id="add-email" class="btn btn-primary btn-sm">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</button>
          </div>
          {{ email_formset.management_form }}
          <table id="email-table" class="table text-center">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th>Ø¥Ø²Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for form in email_formset %}
                <tr class="email-row">
                  <td>{{ form.id }}{{ form.email }}</td>
                  <td>
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                    {% else %}
                      <button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª -->
          <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
            <h4>ğŸ“„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h4>
            <button type="button" id="add-document" class="btn btn-primary btn-sm">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯</button>
          </div>
          {{ document_formset.management_form }}
          <table id="document-table" class="table text-center">
            <thead>
              <tr>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                <th>Ø§Ù„Ù…Ù„Ù</th>
                <th>Ø¥Ø²Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for form in document_formset %}
                <tr class="document-row">
                  <td>{{ form.id }}{{ form.name }}</td>
                  <td>{{ form.file }}</td>
                  <td>
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                      <!-- <input type="checkbox" name="}"> -->
                    {% else %}
                      <button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
            <a href="{% url 'client_list' %}" class="btn btn-secondary mx-2">Ø¥Ù„ØºØ§Ø¡</a>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>

function updateFormsetCount(prefix) {
  let totalFormsInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
  let totalRows = document.querySelectorAll(`#${prefix}-table tbody tr`).length;
  totalFormsInput.value = totalRows;
}

function addRow(tableId, templateClass, formsetPrefix) {
  let table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
  let totalFormsInput = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);
  let index = parseInt(totalFormsInput.value);

  let newRow = document.createElement('tr');
  newRow.className = templateClass;

  if (templateClass === 'phone-row') {
    newRow.innerHTML = `<td><input type="hidden" name="${formsetPrefix}-${index}-id">
                        <input type="text" name="${formsetPrefix}-${index}-phone" required></td>
                        <td><button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button></td>`;
  } else if (templateClass === 'email-row') {
    newRow.innerHTML = `<td><input type="hidden" name="${formsetPrefix}-${index}-id">
                        <input type="email" name="${formsetPrefix}-${index}-email" required></td>
                        <td><button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button></td>`;
  } else if (templateClass === 'document-row') {
    newRow.innerHTML = `<td><input type="hidden" name="${formsetPrefix}-${index}-id">
                        <input type="text" name="${formsetPrefix}-${index}-name" required></td>
                        <td><input type="file" name="${formsetPrefix}-${index}-file"></td>
                        <td><button type="button" class="remove-row btn btn-danger btn-sm text-white"><i class="fas fa-trash-alt"></i></button></td>`;
  }

  table.appendChild(newRow);
  totalFormsInput.value = index + 1;
}

document.getElementById('add-phone').addEventListener('click', () => addRow('phone-table', 'phone-row', 'phones'));
document.getElementById('add-email').addEventListener('click', () => addRow('email-table', 'email-row', 'emails'));
document.getElementById('add-document').addEventListener('click', () => addRow('document-table', 'document-row', 'documents'));

document.addEventListener('click', function(event) {
  if (event.target.classList.contains('remove-row')) {
    let row = event.target.closest('tr');
    row.parentNode.removeChild(row);
    let prefix = row.closest('table').id.replace('-table', '');
    updateFormsetCount(prefix);
  }
});

</script>
{% endblock scripts %}
